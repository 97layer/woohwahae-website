# Night Guard 전용 경량 컨테이너 이미지
# Python 3.10 slim 기반 (GCP e2-micro RAM 1GB 최적화)

FROM python:3.10-slim

# 메타데이터
LABEL maintainer="97LAYER Technical Director"
LABEL description="Night Guard Daemon - 24/7 Trend Surveillance (Podman Optimized)"
LABEL version="1.1.0"

# 작업 디렉토리
WORKDIR /app

# 환경변수 (GCP VM 전용)
ENV ENVIRONMENT=GCP_VM \
    PROCESSING_MODE=sequential \
    ENABLE_MULTIMODAL=false \
    MEMORY_LIMIT_MB=700 \
    AI_MODEL_PREFERENCE=gemini-1.5-flash \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PATH="/app:${PATH}"

# 시스템 패키지 업데이트 (최소화)
RUN apt-get update && apt-get install -y --no-install-recommends \
    git \
    curl \
    && rm -rf /var/lib/apt/lists/*

# requirements.txt 복사 및 설치
COPY requirements.txt /tmp/requirements.txt

# Python 패키지 설치 (캐시 최적화)
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r /tmp/requirements.txt && \
    rm /tmp/requirements.txt

# Podman Secrets 읽기용 헬퍼 함수 생성
RUN echo '#!/usr/bin/env python3\n\
import os\n\
\n\
def read_secret(env_var_name, secret_file_env=None):\n\
    """Podman Secret 또는 환경변수에서 읽기"""\n\
    # 1. Secret 파일에서 읽기 (우선순위)\n\
    if secret_file_env:\n\
        secret_file = os.getenv(secret_file_env)\n\
        if secret_file and os.path.exists(secret_file):\n\
            with open(secret_file, "r") as f:\n\
                return f.read().strip()\n\
    \n\
    # 2. 환경변수에서 직접 읽기 (폴백)\n\
    return os.getenv(env_var_name, "")\n\
' > /usr/local/bin/read_secret.py && chmod +x /usr/local/bin/read_secret.py

# 헬스체크 (Podman Compose에서도 정의됨)
HEALTHCHECK --interval=5m --timeout=10s --retries=3 --start-period=30s \
    CMD python3 execution/system/health_check.py || exit 1

# 컨테이너 실행 시 사용자 (보안 강화 - 선택 사항)
# 볼륨 마운트 권한 문제 방지를 위해 root 유지
# RUN useradd -m -u 1000 nightguard && chown -R nightguard:nightguard /app
# USER nightguard

# 기본 명령어
CMD ["python3", "execution/system/nightguard_daemon.py"]
