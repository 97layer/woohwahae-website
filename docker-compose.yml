version: '3.8'

services:
  # 1. Main Admin & Cockpit
  cortex-admin:
    build: .
    command: python3 core/admin/app.py
    ports:
      - "5001:5001"
    env_file: .env
    volumes:
      - .:/app
    restart: always

  # 2. Dashboard & SSE Stream
  cortex-dashboard:
    build: .
    command: python3 core/daemons/dashboard_server.py
    ports:
      - "8000:8000"
    env_file: .env
    volumes:
      - .:/app
    restart: always

  # 3. Backend Engines (Signal Processor, Telegram Bot)
  cortex-engine:
    build: .
    command: /bin/bash -c "python3 core/system/signal_processor.py & python3 core/daemons/telegram_secretary.py"
    env_file: .env
    volumes:
      - .:/app
    restart: always

  # 4. Remote Code Editor (code-server)
  cortex-editor:
    image: codercom/code-server:latest
    ports:
      - "8080:8080"
    volumes:
      - .:/home/coder/project
    environment:
      - PASSWORD=${EDITOR_PASSWORD:-97layer}
    restart: always

  # 5. Cloudflare Tunnel (TryCloudflare for instant access)
  cortex-tunnel:
    image: cloudflare/cloudflared:latest
    command: tunnel --url http://cortex-admin:5001
    restart: always

networks:
  default:
    name: cortex-network
